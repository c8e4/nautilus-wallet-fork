<template>
  <!-- bg-foreground/5 -->
  <div class="relative mb-4 bg-foreground/5 pt-4">
    <div class="mx-auto w-full bg-transparent text-center">
      <p class="text-2xl">$ {{ format.bn.format(totalWallet, 2) }}</p>
      <p class="text-sm text-muted-foreground">Wallet balance</p>
    </div>

    <AreaChart
      class="h-[80px] w-full"
      index="time"
      :data="data"
      :categories="['price']"
      :show-tooltip="false"
      :show-gradiant="false"
    />
  </div>
  <div class="flex flex-col gap-6 p-4 text-sm">
    <!-- <div>
      <input
        v-model="filter"
        type="text"
        :disabled="loading"
        placeholder="Search"
        class="control block w-full"
      />
    </div> -->
    <storage-rent-box />
    <div v-for="asset in assets" :key="asset.tokenId" class="flex h-10 flex-row gap-2">
      <asset-icon class="h-full" :token-id="asset.tokenId" :type="asset.metadata?.type" />
      <div class="flex flex-grow items-center text-sm">
        <a v-if="isErg(asset.tokenId)" class="font-semibold">
          {{ asset.metadata?.name }}
          <p class="text-xs text-muted-foreground">Ergo</p>
        </a>
        <a v-else class="break-anywhere cursor-pointer" @click="selectedAsset = asset">
          <template v-if="asset.metadata?.name">{{
            format.string.shorten(asset.metadata?.name, 40)
          }}</template>
          <template v-else>{{ format.string.shorten(asset.tokenId, 12) }}</template>
          <p class="text-xs text-muted-foreground">Ergo</p>
        </a>
      </div>
      <div class="whitespace-nowrap text-right align-middle">
        <div v-if="hideBalances" class="flex flex-col items-end gap-1">
          <div class="skeleton h-5 w-full animate-none rounded"></div>
          <div class="skeleton h-3 w-3/4 animate-none rounded"></div>
        </div>
        <template v-else>
          <p>
            {{ format.bn.format(asset.confirmedAmount) }}
          </p>
          <tool-tip
            v-if="!asset.confirmedAmount.isZero() && ergPrice && rate(asset.tokenId)"
            :label="`1 ${asset.metadata?.name} <br /> ≈ ${format.bn.format(
              price(asset.tokenId),
              2
            )} ${format.string.uppercase(conversionCurrency)}`"
          >
            <p class="text-xs text-muted-foreground">
              ≈
              {{ format.bn.format(asset.confirmedAmount.times(price(asset.tokenId)), 2) }}
              {{ format.string.uppercase(conversionCurrency) }}
            </p>
          </tool-tip>
        </template>
      </div>
    </div>

    <asset-info-modal
      :token-id="selectedAsset?.tokenId"
      :confirmed-balance="selectedAsset?.confirmedAmount"
      @close="selectedAsset = undefined"
    />
  </div>
</template>

<script lang="ts">
import { defineComponent } from "vue";
import { BigNumber } from "bignumber.js";
import { EyeIcon, EyeOffIcon } from "lucide-vue-next";
import { ERG_TOKEN_ID } from "@/constants/ergo";
import EmptyLogo from "@/assets/images/tokens/asset-empty.svg";
import AssetInfoModal from "@/components/AssetInfoModal.vue";
import StorageRentBox from "@/components/StorageRentBox.vue";
import { useAppStore } from "@/stores/appStore";
import { useAssetsStore } from "@/stores/assetsStore";
import { StateAssetSummary, useWalletStore } from "@/stores/walletStore";
import { bn } from "@/common/bigNumber";
import { useFormat } from "@/composables/useFormat";
import { AreaChart } from "@/components/ui/chart-area";

const rawPrices = [
  [1734631294299, 1.73129232849255],
  [1734631588038, 1.72190520217631],
  [1734631888781, 1.71970566981798],
  [1734632190806, 1.71919532412749],
  [1734632480839, 1.71334331054994],
  [1734632781781, 1.71842664399081],
  [1734633095539, 1.72093712619708],
  [1734633391773, 1.71880604923345],
  [1734633685295, 1.72485531331478],
  [1734633980895, 1.72164623345684],
  [1734634288362, 1.71819529565952],
  [1734634590217, 1.71369781613408],
  [1734634892601, 1.71729598285326],
  [1734635190159, 1.7195901867411],
  [1734635482916, 1.71320967764791],
  [1734635789844, 1.71055182354262],
  [1734636093312, 1.71538482975598],
  [1734636390280, 1.71149979533345],
  [1734636696092, 1.70534716383949],
  [1734636988887, 1.70612391142139],
  [1734637351476, 1.70209016908163],
  [1734637590291, 1.69769947827133],
  [1734637890570, 1.69427525077969],
  [1734638182485, 1.69042777527722],
  [1734638492913, 1.70116201667626],
  [1734638948171, 1.69972588898772],
  [1734639145646, 1.69191039937968],
  [1734639394926, 1.68509782380995],
  [1734639698445, 1.69033591050087],
  [1734639992397, 1.69072081163291],
  [1734640299068, 1.68680256094468],
  [1734640580057, 1.67608001096857],
  [1734640892325, 1.67579575408863],
  [1734641182443, 1.68097636794697],
  [1734641482627, 1.67922194707416],
  [1734641789858, 1.6778956007156],
  [1734642340558, 1.67435891908069],
  [1734642484170, 1.68446531220761],
  [1734642680955, 1.68872498353219],
  [1734642988244, 1.69457320944902],
  [1734643283933, 1.69438302266661],
  [1734643591272, 1.69663895821181],
  [1734643948235, 1.69357993563683],
  [1734644188237, 1.69860437948205],
  [1734644489593, 1.70690837609288],
  [1734644781156, 1.70499215661044],
  [1734645093545, 1.70440760971282],
  [1734645394072, 1.70194383451348],
  [1734645692440, 1.70076228988626],
  [1734645988396, 1.71377545620295],
  [1734646288383, 1.72318222847973],
  [1734646590798, 1.73399339280114],
  [1734646890459, 1.73014015045382],
  [1734647182754, 1.73096840929481],
  [1734647490623, 1.73073542466137],
  [1734647788388, 1.73145314992675],
  [1734648089090, 1.73320479558276],
  [1734648389270, 1.73667090673866],
  [1734648689155, 1.74028017317714],
  [1734648990000, 1.73863280960375],
  [1734649285960, 1.73635601547883],
  [1734649593594, 1.73111605383077],
  [1734649881295, 1.74549646397586],
  [1734650191303, 1.74799819959871],
  [1734650488220, 1.74607711455078],
  [1734650792818, 1.7478621609891],
  [1734651090918, 1.74394779701174],
  [1734651377971, 1.7353196052287],
  [1734651746889, 1.73561594821858],
  [1734651988401, 1.72563951123792],
  [1734652290905, 1.72405071887016],
  [1734652610260, 1.72288220423175],
  [1734653148257, 1.72288847094287],
  [1734653388845, 1.72320111117658],
  [1734653529781, 1.72231520185086],
  [1734653791650, 1.71861563989052],
  [1734654097806, 1.71430575707349],
  [1734654393174, 1.71792351516865],
  [1734654689190, 1.71474962927079],
  [1734654998180, 1.71820621484394],
  [1734655307367, 1.72078239514273],
  [1734655588466, 1.71784678330819],
  [1734655887964, 1.7135971947554],
  [1734656189279, 1.71461636937535],
  [1734656492067, 1.71423206510004],
  [1734656791739, 1.71577169694465],
  [1734657091961, 1.70927074504202],
  [1734657388095, 1.71226839044781],
  [1734657688195, 1.70973752842363],
  [1734657989104, 1.71156635712299],
  [1734658288390, 1.7116825907151],
  [1734658590277, 1.71442686189176],
  [1734658880576, 1.70876211339597],
  [1734659189641, 1.70968724192257],
  [1734659527924, 1.70955777615902],
  [1734659781028, 1.70138907548184],
  [1734660099584, 1.70633333961937],
  [1734660391984, 1.70497969547647],
  [1734660687613, 1.70329665898199],
  [1734660990903, 1.7061574717787],
  [1734661286463, 1.70245617044655],
  [1734661589929, 1.70274646890438],
  [1734661890126, 1.70313225729838],
  [1734662190176, 1.70530103268272],
  [1734662492409, 1.6956526800836],
  [1734662786290, 1.69415805037101],
  [1734663088610, 1.70097125071375],
  [1734663390764, 1.69645225980876],
  [1734663691906, 1.70332485768437],
  [1734664008872, 1.71370844571826],
  [1734664291638, 1.69349792314219],
  [1734664597900, 1.69950030475145],
  [1734664889132, 1.70431374137858],
  [1734665189238, 1.70914763006354],
  [1734665547747, 1.70408120175009],
  [1734665797806, 1.70290739698923],
  [1734666089202, 1.70355306007993],
  [1734666389686, 1.70008448606692],
  [1734666693183, 1.70054324193613],
  [1734666987599, 1.69759729788825],
  [1734667297805, 1.69210643615146],
  [1734667587256, 1.69237625161015],
  [1734667889854, 1.68794382183926],
  [1734668188551, 1.69463730697621],
  [1734668548045, 1.69619398768799],
  [1734668791373, 1.69318555264454],
  [1734669081026, 1.69464023855611],
  [1734669397662, 1.69742411122983],
  [1734669689834, 1.69611414603266],
  [1734670005359, 1.69042663904442],
  [1734670341341, 1.69034711444806],
  [1734670590078, 1.68537922586702],
  [1734670892017, 1.68375977815469],
  [1734671189281, 1.68665266424435],
  [1734671486079, 1.68209594764545],
  [1734671785249, 1.68212485220148],
  [1734672148997, 1.67906028683977],
  [1734672390567, 1.67840820284642],
  [1734672686768, 1.67570542735789],
  [1734672979506, 1.67303092142273],
  [1734673291158, 1.67366467552325],
  [1734673590017, 1.67386007141907],
  [1734673877147, 1.67698470815584],
  [1734674179176, 1.67698934237789],
  [1734674495194, 1.67762168749097],
  [1734674784144, 1.68135175385054],
  [1734675086646, 1.67829664977564],
  [1734675388197, 1.67473875058697],
  [1734675749373, 1.68219177357374],
  [1734675989722, 1.68117383522194],
  [1734676285828, 1.67522471714783],
  [1734676587818, 1.66872137717871],
  [1734676887588, 1.67589809990195],
  [1734677185188, 1.6748440838182],
  [1734677503574, 1.6721417770744],
  [1734677788929, 1.66849073481165],
  [1734678150253, 1.67368156581745],
  [1734678390372, 1.67216231973922],
  [1734678682756, 1.67216923505798],
  [1734678987675, 1.67248732256216],
  [1734679282754, 1.67086140998211],
  [1734679587975, 1.67128606586761],
  [1734679890282, 1.67077423438603],
  [1734680178170, 1.67512472663885],
  [1734680491674, 1.68067879114382],
  [1734680788648, 1.68136642956057],
  [1734681082721, 1.67806728989337],
  [1734681386050, 1.67585401704077],
  [1734681687427, 1.67816725477126],
  [1734681989294, 1.67513279793105],
  [1734682290789, 1.67125097664556],
  [1734682588176, 1.64751337618595],
  [1734682892565, 1.64582410608691],
  [1734683184405, 1.64192377739147],
  [1734683484870, 1.64065357505343],
  [1734683789155, 1.63978595259275],
  [1734684088404, 1.6356886145689],
  [1734684387573, 1.63634731029588],
  [1734684689208, 1.6331036079651],
  [1734684988044, 1.62907583147329],
  [1734685291573, 1.63200855394786],
  [1734685580261, 1.62739497117021],
  [1734685886847, 1.61405157843623],
  [1734686182336, 1.6053310433363],
  [1734686489559, 1.60950289388862],
  [1734686787583, 1.60250210354551],
  [1734687088358, 1.58753060776493],
  [1734687388220, 1.58733958889336],
  [1734687690167, 1.58547471524306],
  [1734687981305, 1.58226774173055],
  [1734688281113, 1.57956559041473],
  [1734688581146, 1.5797363279286],
  [1734688897606, 1.57146859620653],
  [1734689311699, 1.56222948195323],
  [1734689486021, 1.5597389834699],
  [1734689790693, 1.54047555643295],
  [1734690089759, 1.5457502574283],
  [1734690384857, 1.52390917758467],
  [1734690680509, 1.52767870907539],
  [1734690994022, 1.52170106725429],
  [1734691286389, 1.5259068208201],
  [1734691588484, 1.5284640562092],
  [1734691883631, 1.53374958038001],
  [1734692188122, 1.5243030001897],
  [1734692588084, 1.52428962335265],
  [1734692788320, 1.52440886922852],
  [1734693082404, 1.52197633628369],
  [1734693385365, 1.52315597092469],
  [1734693688489, 1.51714049309906],
  [1734693988446, 1.50992744408656],
  [1734694292910, 1.50535761403517],
  [1734694592407, 1.49513663004281],
  [1734694884937, 1.4837266360204],
  [1734695188138, 1.48048007870186],
  [1734695548694, 1.46868369708638],
  [1734695778415, 1.48711169377085],
  [1734696093178, 1.48058319983564],
  [1734696378226, 1.48222544372923],
  [1734696687809, 1.47645703638441],
  [1734696977379, 1.47012330202908],
  [1734697288697, 1.46981390218102],
  [1734697586926, 1.46436950865255],
  [1734697889320, 1.4657632732247],
  [1734698189193, 1.46356056937276],
  [1734698489166, 1.46870834478462],
  [1734698790033, 1.47454888754437],
  [1734699147379, 1.48132965831733],
  [1734699382401, 1.48402248606633],
  [1734699960534, 1.50208392270228],
  [1734700180747, 1.48872882448055],
  [1734700358131, 1.49343288309726],
  [1734700581601, 1.50398179112179],
  [1734700962751, 1.49525681018435],
  [1734701189989, 1.48904646692346],
  [1734701491961, 1.49135479530887],
  [1734701790087, 1.4998324992971],
  [1734702090123, 1.50092811209293],
  [1734702390877, 1.50357568193485],
  [1734702687656, 1.50428440647135],
  [1734702990376, 1.51884053882806],
  [1734703558558, 1.52182064230844],
  [1734703887672, 1.52728264782567],
  [1734704184469, 1.52776870011626],
  [1734704479829, 1.52485854532872],
  [1734704782285, 1.52378750712609],
  [1734705084685, 1.53636691493811],
  [1734705390209, 1.53672368209131],
  [1734705689364, 1.54600821098686],
  [1734705988093, 1.54569267835963],
  [1734706287227, 1.54323891825115],
  [1734706581537, 1.54722409167675],
  [1734706900056, 1.55582864413005],
  [1734707167759, 1.55463451380602],
  [1734707494119, 1.5515914447839],
  [1734707790066, 1.55673885736823],
  [1734708093152, 1.55390450535938],
  [1734708387965, 1.56045758346672],
  [1734708691083, 1.55981372292083],
  [1734708991078, 1.56323136819782],
  [1734709296378, 1.56817409897284],
  [1734709590461, 1.56426924339018],
  [1734709881803, 1.56473908750531],
  [1734710182959, 1.56168493544522],
  [1734710494842, 1.5674529641962],
  [1734710778365, 1.58209456908611],
  [1734711086544, 1.57887906301018],
  [1734711390635, 1.58265965994856],
  [1734711758245, 1.58457147928067],
  [1734711990048, 1.58433589579707],
  [1734712280093, 1.58127209513154],
  [1734712590518, 1.57984392654025],
  [1734712947385, 1.57955082475053],
  [1734713189140, 1.58787211721857],
  [1734713551033, 1.57031484825718],
  [1734713792638, 1.60044698295376],
  [1734714094652, 1.63303240272201],
  [1734714390999, 1.63616471221884],
  [1734714689248, 1.64961594071732],
  [1734714988864, 1.65318286625694],
  [1734715290413, 1.65890148446967],
  [1734715591649, 1.65753050075591],
  [1734715882434, 1.66389981547493],
  [1734716191134, 1.66355779170555],
  [1734716497356, 1.66265239539133],
  [1734716790950, 1.66106806177856],
  [1734717098575, 1.67569950271967],
  [1734717383995, 1.70356560152353],
  [1734717535000, 1.701419034385]
].filter((_, i) => i % 2 === 0);
// .map((x) => [x[0], x[1].toPrecision(4)]);

export default defineComponent({
  name: "AssetsView",
  components: {
    EmptyLogo,
    AssetInfoModal,
    StorageRentBox,
    EyeIcon,
    EyeOffIcon,
    AreaChart
  },
  setup() {
    return {
      app: useAppStore(),
      assetsStore: useAssetsStore(),
      wallet: useWalletStore(),
      format: useFormat()
    };
  },
  data() {
    return {
      data: rawPrices.map((x) => ({ time: x[0], price: x[1] })),
      filter: "",
      prevCount: 1,
      selectedAsset: undefined as StateAssetSummary | undefined
    };
  },
  computed: {
    ergPrice(): number {
      return this.assetsStore.prices.get(ERG_TOKEN_ID)?.fiat ?? 0;
    },
    conversionCurrency(): string {
      return this.app.settings.conversionCurrency;
    },
    loading(): boolean {
      return this.wallet.loading && this.wallet.nonArtworkBalance.length === 0;
    },
    assets() {
      const assetList = this.wallet.nonArtworkBalance;

      if (this.filter !== "" && assetList.length > 0) {
        return assetList.filter((a) =>
          a.metadata?.name?.toLocaleLowerCase().includes(this.filter.toLocaleLowerCase())
        );
      }

      return assetList;
    },
    hideBalances(): boolean {
      return this.app.settings.hideBalances;
    },
    totalWallet(): BigNumber {
      return this.wallet.nonArtworkBalance
        .reduce((acc, a) => acc.plus(a.confirmedAmount.times(this.rate(a.tokenId))), bn(0))
        .times(this.ergPrice);
    }
  },
  watch: {
    ["assets.length"](_, oldLen) {
      const length = oldLen || 1;
      if (length > 1) this.prevCount = length;
    }
  },
  methods: {
    price(tokenId: string): BigNumber {
      const rate = this.rate(tokenId);
      if (!rate || !this.ergPrice) return bn(0);
      return bn(rate).times(this.ergPrice);
    },
    rate(tokenId: string): number {
      return this.assetsStore.prices.get(tokenId)?.erg ?? 0;
    },
    isErg(tokenId: string): boolean {
      return tokenId === ERG_TOKEN_ID;
    },
    toggleHideBalance(): void {
      this.app.settings.hideBalances = !this.app.settings.hideBalances;
    }
  }
});
</script>
