<template>
  <!-- bg-foreground/5 -->
  <div class="relative mb-4 bg-foreground/5 pt-4">
    <div class="mx-auto w-full bg-transparent text-center">
      <p class="text-2xl">$ {{ format.bn.format(totalWallet, 2) }}</p>
      <p class="text-sm text-muted-foreground">Wallet balance</p>
    </div>

    <SparklineChart
      class="h-[80px] w-full"
      index="time"
      :data="data"
      :categories="['price']"
      :show-tooltip="false"
    />
  </div>
  <div class="px-4">
    <storage-rent-box />

    <Tabs default-value="tokens" class="w-full">
      <TabsList class="m-auto">
        <TabsTrigger value="tokens"> Tokens</TabsTrigger>
        <TabsTrigger value="collectibles"> Collectibles </TabsTrigger>
      </TabsList>
      <!-- <Input
        v-model="filter"
        class="text-xs"
        type="text"
        :disabled="loading"
        placeholder="Search"
      /> -->

      <TabsContent value="tokens" class="flex flex-col gap-6 p-4">
        <div v-for="asset in assets" :key="asset.tokenId" class="flex h-10 flex-row gap-2">
          <asset-icon class="h-full" :token-id="asset.tokenId" :type="asset.metadata?.type" />
          <div class="flex flex-grow items-center text-sm">
            <a v-if="isErg(asset.tokenId)" class="font-semibold">
              {{ asset.metadata?.name }}
              <p class="text-xs text-muted-foreground">Ergo</p>
            </a>
            <a v-else class="break-anywhere cursor-pointer" @click="selectedAsset = asset">
              <template v-if="asset.metadata?.name">{{
                format.string.shorten(asset.metadata?.name, 40)
              }}</template>
              <template v-else>{{ format.string.shorten(asset.tokenId, 12) }}</template>
              <p class="text-xs text-muted-foreground">Ergo</p>
            </a>
          </div>
          <div class="whitespace-nowrap text-right align-middle">
            <div v-if="hideBalances" class="flex flex-col items-end gap-1">
              <div class="skeleton h-5 w-full animate-none rounded"></div>
              <div class="skeleton h-3 w-3/4 animate-none rounded"></div>
            </div>
            <template v-else>
              <p>
                {{ format.bn.format(asset.confirmedAmount) }}
              </p>
              <tool-tip
                v-if="!asset.confirmedAmount.isZero() && ergPrice && rate(asset.tokenId)"
                :label="`1 ${asset.metadata?.name} <br /> ≈ ${format.bn.format(
                  price(asset.tokenId),
                  2
                )} ${format.string.uppercase(conversionCurrency)}`"
              >
                <p class="text-xs text-muted-foreground">
                  ≈
                  {{ format.bn.format(asset.confirmedAmount.times(price(asset.tokenId)), 2) }}
                  {{ format.string.uppercase(conversionCurrency) }}
                </p>
              </tool-tip>
            </template>
          </div>
        </div>
      </TabsContent>
      <TabsContent value="collectibles"> Collectibles </TabsContent>
    </Tabs>
  </div>
  <div class="flex flex-col gap-6 p-2 text-sm">
    <asset-info-modal
      :token-id="selectedAsset?.tokenId"
      :confirmed-balance="selectedAsset?.confirmedAmount"
      @close="selectedAsset = undefined"
    />
  </div>
</template>

<script lang="ts">
import { defineComponent } from "vue";
import { BigNumber } from "bignumber.js";
import { EyeIcon, EyeOffIcon } from "lucide-vue-next";
import SparklineChart from "./SparklineChart.vue";
import { ERG_TOKEN_ID } from "@/constants/ergo";
import EmptyLogo from "@/assets/images/tokens/asset-empty.svg";
import AssetInfoModal from "@/components/AssetInfoModal.vue";
import StorageRentBox from "@/components/StorageRentBox.vue";
import { useAppStore } from "@/stores/appStore";
import { useAssetsStore } from "@/stores/assetsStore";
import { StateAssetSummary, useWalletStore } from "@/stores/walletStore";
import { bn } from "@/common/bigNumber";
import { useFormat } from "@/composables/useFormat";
import { Tabs, TabsContent, TabsList, TabsTrigger } from "@/components/ui/tabs";
import { Input } from "@/components/ui/input";

const rawPrices = [
  [1734717688198, 1.70133570930476],
  [1734717987986, 1.7114849201416],
  [1734718291205, 1.70444631149571],
  [1734718588721, 1.70024278570951],
  [1734718895992, 1.70896856162432],
  [1734719189650, 1.69986801576077],
  [1734719488434, 1.69809315573305],
  [1734719789892, 1.69688515370539],
  [1734720098009, 1.70113362108267],
  [1734720391771, 1.69939698230107],
  [1734720689818, 1.69687027715908],
  [1734720987187, 1.69686029029703],
  [1734721566296, 1.69283757910952],
  [1734721702075, 1.70461579449268],
  [1734721876948, 1.70439806194231],
  [1734722192525, 1.70700878959883],
  [1734722490076, 1.71441318495101],
  [1734722781697, 1.75036019641444],
  [1734723099729, 1.75033636327882],
  [1734723390378, 1.76266712447058],
  [1734723692440, 1.75691334739359],
  [1734723992061, 1.75717697200263],
  [1734724279342, 1.75875886161212],
  [1734724591988, 1.75292658333327],
  [1734724899921, 1.7554182749098],
  [1734725189540, 1.74994350049394],
  [1734725489255, 1.7511415973074],
  [1734725787730, 1.75066187770467],
  [1734726085088, 1.74931421457577],
  [1734726391892, 1.7472416162639],
  [1734726686678, 1.74450660864521],
  [1734726986404, 1.74303363094891],
  [1734727291408, 1.74328403867928],
  [1734727590961, 1.7399601441885],
  [1734727963111, 1.74377366822945],
  [1734728188434, 1.7429658341856],
  [1734728520128, 1.73864073919475],
  [1734728790481, 1.73935072050709],
  [1734729150149, 1.75468266296601],
  [1734729389184, 1.75533349222019],
  [1734729686544, 1.75006636847467],
  [1734729990611, 1.74597573032376],
  [1734730291023, 1.73841226017813],
  [1734730581578, 1.74344769528165],
  [1734730890153, 1.74054381066793],
  [1734731189422, 1.74127557229403],
  [1734731551926, 1.73617808082929],
  [1734731785913, 1.74263852086216],
  [1734732164478, 1.74299788228982],
  [1734732430997, 1.74380980881994],
  [1734732690763, 1.74177782618779],
  [1734732980583, 1.7500337609443],
  [1734733283964, 1.7526635023744],
  [1734733589687, 1.75014628775762],
  [1734733890196, 1.75187947842279],
  [1734734184264, 1.74836217264495],
  [1734734497199, 1.7663195914836],
  [1734734789679, 1.7762002373596],
  [1734735084101, 1.79234232313556],
  [1734735385134, 1.80384396327509],
  [1734735701597, 1.80965277522277],
  [1734735991057, 1.80971881543013],
  [1734736284993, 1.81196157122994],
  [1734736582336, 1.81115043384234],
  [1734736887275, 1.81032998526423],
  [1734737189237, 1.81470966461611],
  [1734737482322, 1.81333245312161],
  [1734737783732, 1.81646634566296],
  [1734738088233, 1.81138027645909],
  [1734738390235, 1.81266438937238],
  [1734738690517, 1.81130215829662],
  [1734738987012, 1.8112984777011],
  [1734739537865, 1.80923855185325],
  [1734739698000, 1.81271216322866],
  [1734739891581, 1.80956083201982],
  [1734740189839, 1.80853826944595],
  [1734740490359, 1.80946340297456],
  [1734740789312, 1.8120611410517],
  [1734741092146, 1.80967889884593],
  [1734741377806, 1.80949617258546],
  [1734741694426, 1.81244350029366],
  [1734741987693, 1.8098915407387],
  [1734742286297, 1.81083588253754],
  [1734742588542, 1.8096080795875],
  [1734742891971, 1.81217309274202],
  [1734743182312, 1.80721439981845],
  [1734743490158, 1.80973555080187],
  [1734743788490, 1.80686449090996],
  [1734744091421, 1.81257093696179],
  [1734744393340, 1.81868732321955],
  [1734744684157, 1.81667578980624],
  [1734744983957, 1.81893505762276],
  [1734745290296, 1.81543960626371],
  [1734745587732, 1.81480328654137],
  [1734745882347, 1.81528266817199],
  [1734746189125, 1.81213154987012],
  [1734746766028, 1.81166775311426],
  [1734747082676, 1.80991474988033],
  [1734747390438, 1.81038606424614],
  [1734747701113, 1.80935432766605],
  [1734747978690, 1.81052487775015],
  [1734748289755, 1.80843482678732],
  [1734748590927, 1.80689238854506],
  [1734748899295, 1.80572059141901],
  [1734749189926, 1.80507549133567],
  [1734749485716, 1.80372682641555],
  [1734749788447, 1.80499891990754],
  [1734750077950, 1.80261553302422],
  [1734750393673, 1.80255985952662],
  [1734750685581, 1.80299041175543],
  [1734750990206, 1.80346072585485],
  [1734751290149, 1.80420724920045],
  [1734751588300, 1.80389880474219],
  [1734751891353, 1.80401763068595],
  [1734752187959, 1.80487019543336],
  [1734752489673, 1.8041224150045],
  [1734752788231, 1.80212851269744],
  [1734753088764, 1.80022012166197],
  [1734753387803, 1.80142436040459],
  [1734753687427, 1.80024756546249],
  [1734753981190, 1.80149770439386],
  [1734754289767, 1.80158902514266],
  [1734754588199, 1.80151520807781],
  [1734754885448, 1.80292508156578],
  [1734755187287, 1.8050273327109],
  [1734755487900, 1.80138661967839],
  [1734755781602, 1.80530484709368],
  [1734756087959, 1.80361621889824],
  [1734756392594, 1.80177046519077],
  [1734756684223, 1.80245425168034],
  [1734756992060, 1.80240536315538],
  [1734757638205, 1.79965334495706],
  [1734757890275, 1.80027238139201],
  [1734758191023, 1.80058031370576],
  [1734758477448, 1.80007230322917],
  [1734758784283, 1.80352672515713],
  [1734759085632, 1.80328185620665],
  [1734759378429, 1.80009273806104],
  [1734759691337, 1.80046641239],
  [1734759990426, 1.80376108521947],
  [1734760296023, 1.80497224477024],
  [1734760589001, 1.80593139626831],
  [1734760893406, 1.81002148632368],
  [1734761230306, 1.81181300107274],
  [1734761477172, 1.81468587542327],
  [1734761790321, 1.81076825712042],
  [1734762082938, 1.82428633876637],
  [1734762389684, 1.82500534591421],
  [1734762687784, 1.8259927265053],
  [1734762991006, 1.83136292179455],
  [1734763290812, 1.82761268305203],
  [1734763591190, 1.82865140957271],
  [1734763941691, 1.8290686978229],
  [1734764200311, 1.83333042964734],
  [1734764497555, 1.83206137493849],
  [1734764784952, 1.82918987691266],
  [1734765088934, 1.82812804881747],
  [1734765389348, 1.8261342543848],
  [1734765678997, 1.82642268276521],
  [1734765990833, 1.83180014303168],
  [1734766278447, 1.82638231070813],
  [1734766584078, 1.8255707450993],
  [1734766887366, 1.8373692571445],
  [1734767188703, 1.82488051559756],
  [1734767490065, 1.83624134130572],
  [1734767789892, 1.81704137200535],
  [1734768082919, 1.82637388179702],
  [1734768388612, 1.82324189725745],
  [1734768689585, 1.82678552367153],
  [1734768987249, 1.82766907514378],
  [1734769291655, 1.81902919254542],
  [1734769592922, 1.81683200226033],
  [1734769887045, 1.81596560494079],
  [1734770184528, 1.81443524618109],
  [1734770488228, 1.81213505967848],
  [1734770787608, 1.81260549264729],
  [1734771088679, 1.80672565224451],
  [1734771387203, 1.80317606211696],
  [1734771689730, 1.80360237165074],
  [1734771987676, 1.80054153584564],
  [1734772283910, 1.80025496347864],
  [1734772590098, 1.8025511661626],
  [1734772897693, 1.79888517311391],
  [1734773187214, 1.7962427363844],
  [1734773482096, 1.79583071944198],
  [1734773788935, 1.79060704263643],
  [1734774077355, 1.78298424996777],
  [1734774380520, 1.77650544567041],
  [1734774678730, 1.77265342763605],
  [1734774991395, 1.77156861082364],
  [1734775288624, 1.77043642029949],
  [1734775593042, 1.76907498125851],
  [1734775891037, 1.76018913484033],
  [1734776184644, 1.76259597704885],
  [1734776501500, 1.76384558633029],
  [1734776784165, 1.76776701003603],
  [1734777091579, 1.76736310750243],
  [1734777389479, 1.76425600601018],
  [1734777689576, 1.75259126354495],
  [1734777988830, 1.74183000345717],
  [1734778289581, 1.73913437662584],
  [1734778589430, 1.73923268644263],
  [1734778887485, 1.75182204970616],
  [1734779191110, 1.7621353790433],
  [1734779487503, 1.76500850879624],
  [1734779780372, 1.7605587177381],
  [1734780087263, 1.76171932540506],
  [1734780385700, 1.75080575590563],
  [1734780690231, 1.75617138367031],
  [1734780986359, 1.7532670838603],
  [1734781288039, 1.75382748076592],
  [1734781588878, 1.75571651227155],
  [1734781885591, 1.75814632854051],
  [1734782184390, 1.75993394749059],
  [1734782492549, 1.75742499257797],
  [1734782789925, 1.75919369330284],
  [1734783082218, 1.75640317266103],
  [1734783392224, 1.75715133095849],
  [1734783683770, 1.76278144246882],
  [1734783990762, 1.76164510502447],
  [1734784291641, 1.7592966484178],
  [1734784589082, 1.7549559742603],
  [1734784888198, 1.75364421277555],
  [1734785192146, 1.74927742940943],
  [1734785548446, 1.74799771851154],
  [1734785793519, 1.74565342089746],
  [1734786349195, 1.74431408422073],
  [1734786556922, 1.74163838883001],
  [1734786699508, 1.74219626786756],
  [1734786989872, 1.74093031562256],
  [1734787281217, 1.73565908748495],
  [1734787589855, 1.73020691458936],
  [1734787894055, 1.73719756962893],
  [1734788189121, 1.73769240042394],
  [1734788480435, 1.73663000818357],
  [1734788788289, 1.74291616515901],
  [1734789079594, 1.74319067975171],
  [1734789388167, 1.74027797100288],
  [1734789686958, 1.74138510201899],
  [1734789984227, 1.74105390999378],
  [1734790285833, 1.73873585898209],
  [1734790592616, 1.73904489233525],
  [1734790950895, 1.73581689172802],
  [1734791189929, 1.73095642156418],
  [1734791489499, 1.7301525321972],
  [1734791788022, 1.73002989006612],
  [1734792077797, 1.73144478549615],
  [1734792387733, 1.73398042323942],
  [1734792689608, 1.73264537918681],
  [1734792990443, 1.73249325197239],
  [1734793296598, 1.73507243204718],
  [1734793587297, 1.72988812433849],
  [1734793889782, 1.74378776730827],
  [1734794189395, 1.7393183751206],
  [1734794501725, 1.73337049665434],
  [1734794791359, 1.74238836612102],
  [1734795147411, 1.73934668028518],
  [1734795387932, 1.7345955697202],
  [1734795743550, 1.73470356545754],
  [1734795986895, 1.73088960196848],
  [1734796286762, 1.73115125473813],
  [1734796588194, 1.72886398678903],
  [1734796886504, 1.72678029131085],
  [1734797186165, 1.72406908383011],
  [1734797487451, 1.72686122010201],
  [1734797789133, 1.7450042513965],
  [1734798089837, 1.74327758423903],
  [1734798387634, 1.74418110365792],
  [1734798688139, 1.7503835795373],
  [1734798988404, 1.74660370934207],
  [1734799286937, 1.75186140212197],
  [1734799590485, 1.74722461923819],
  [1734799887163, 1.75037739298992],
  [1734800190576, 1.75023431007966],
  [1734800488838, 1.74781782175309],
  [1734800790905, 1.74940436543544],
  [1734801089759, 1.74592263695973],
  [1734801388105, 1.7531966102908],
  [1734801692051, 1.75506686319735],
  [1734801988027, 1.75372042311747],
  [1734802288692, 1.75400782814935],
  [1734802580220, 1.75459621264617],
  [1734802887919, 1.75231879780877],
  [1734803182759, 1.75311883382536],
  [1734803489679, 1.75192433831232],
  [1734803780539, 1.75108614891473],
  [1734803917000, 1.75624086106375]
].filter((_, i) => i % 2 === 0);
// .map((x) => [x[0], x[1].toPrecision(4)]);

export default defineComponent({
  name: "AssetsView",
  components: {
    EmptyLogo,
    AssetInfoModal,
    StorageRentBox,
    EyeIcon,
    EyeOffIcon,
    SparklineChart,
    Tabs,
    TabsContent,
    TabsList,
    TabsTrigger,
    Input
  },
  setup() {
    return {
      app: useAppStore(),
      assetsStore: useAssetsStore(),
      wallet: useWalletStore(),
      format: useFormat()
    };
  },
  data() {
    return {
      data: rawPrices.map((x) => ({ time: x[0], price: x[1] })),
      filter: "",
      prevCount: 1,
      selectedAsset: undefined as StateAssetSummary | undefined
    };
  },
  computed: {
    ergPrice(): number {
      return this.assetsStore.prices.get(ERG_TOKEN_ID)?.fiat ?? 0;
    },
    conversionCurrency(): string {
      return this.app.settings.conversionCurrency;
    },
    loading(): boolean {
      return this.wallet.loading && this.wallet.nonArtworkBalance.length === 0;
    },
    assets() {
      const assetList = this.wallet.nonArtworkBalance;

      if (this.filter !== "" && assetList.length > 0) {
        return assetList.filter((a) =>
          a.metadata?.name?.toLocaleLowerCase().includes(this.filter.toLocaleLowerCase())
        );
      }

      return assetList;
    },
    hideBalances(): boolean {
      return this.app.settings.hideBalances;
    },
    totalWallet(): BigNumber {
      return this.wallet.nonArtworkBalance
        .reduce((acc, a) => acc.plus(a.confirmedAmount.times(this.rate(a.tokenId))), bn(0))
        .times(this.ergPrice);
    }
  },
  watch: {
    ["assets.length"](_, oldLen) {
      const length = oldLen || 1;
      if (length > 1) this.prevCount = length;
    }
  },
  methods: {
    price(tokenId: string): BigNumber {
      const rate = this.rate(tokenId);
      if (!rate || !this.ergPrice) return bn(0);
      return bn(rate).times(this.ergPrice);
    },
    rate(tokenId: string): number {
      return this.assetsStore.prices.get(tokenId)?.erg ?? 0;
    },
    isErg(tokenId: string): boolean {
      return tokenId === ERG_TOKEN_ID;
    },
    toggleHideBalance(): void {
      this.app.settings.hideBalances = !this.app.settings.hideBalances;
    }
  }
});
</script>
